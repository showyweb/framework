/**
 * Name:    SHOWYWEB TEXT EDITOR JS
 * Version: 2.6.3
 * Author:  Novojilov Pavel Andreevich
 * Support: http://SHOWYWEB.ru
 * License: Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0) https://creativecommons.org/licenses/by-nc-nd/4.0/
 */
SW_TE={reinit:function(){setTimeout(SW_TE.reinit,100)},check_browser:function(){var e=SW_BS.browser,t={msie:10,opera:31,firefox:40,chrome:44,safari:600,webkit:537},a={msie:t.msie,opera:t.opera,firefox:"40.0.3",chrome:"44.0.2403.157",safari:"7.1",webkit:t.webkit},i=!1,n="",r="";if(e.msie&&e.version<t.msie&&(n="http://windows.microsoft.com/ru-RU/internet-explorer/downloads/ie",r=a.msie,i=!0),e.opera?e.version<t&&(n="http://ru.opera.com/browser/",r=a.opera,i=!0):e.firefox?e.version<t.firefox&&(n="http://www.mozilla.com/ru/firefox/",r=a.firefox,i=!0):e.chrome?e.version<t.chrome&&(n="http://www.google.com/chrome/",r=a.chrome,i=!0):e.safari?e.version<t.safari&&(n="http://www.apple.com/ru/safari/",e.isMobile.iOS&&(n="https://support.apple.com/ru-ru/HT204204"),r=a.safari,i=!0):e.webkit&&e.version<t.webkit&&(i=!0,n="https://www.google.ru/?q=%D0%B1%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80%D1%8B%20%D0%BD%D0%B0%20webkit",r=a.webkit),i){var o="Для корректной работы текстового редактора, требуется версия интернет браузера "+e.name+" не ниже "+r+'. Пожалуйста обновите ваш браузер, сделать это можно перейдя по этой <a href="'+n+'">ссылке</a>';smart_text_box.show_text_window(o)}}},$(document).ready(function(){var e=document,t=window,a=SW_BS.browser,i=["b","strong"],n=["i","em"],r="u",o="h1",l="a",s="ul",c={checkForFormatting:function(e,a){if("string"==typeof a&&(a=[a]),null==e){for(var i=this.selection.getHtml(),n="(",r=0;r<a.length;r++){s=a[r];0!=r&&(n+="|"),n+=s}n="<"+(n+=")")+">.*</"+n+">",n=new RegExp(n,"ig");var o=null!=i.match(n);return n="(<[^/][^<>]*?>[^<>]*?</[^<>]*?>|<[^<>]*?>) ?",n=new RegExp(n,"ig"),""==(i=i.replace(n,""))&&o}for(var l="",r=0;r<a.length;r++){var s=a[r];0!=r&&(l+=","),l+=s}var c=e;return!!t.$(c).is(l)||this.checkForFormatting(c.parentNode,a)},get_currentNode:function(){var e=this.selection.save();return this.selection.getContainer(e)},selection:{save:function(){if(t.getSelection){var a=t.getSelection();if(a.rangeCount>0)return a.getRangeAt(0)}else if(e.selection&&e.selection.createRange)return e.selection.createRange();return null},restore:function(a){if(a)if(t.getSelection){var i=t.getSelection();i.removeAllRanges(),i.addRange(a)}else e.selection&&a.select&&a.select()},getText:function(){var a="";return t.getSelection?a=t.getSelection().toString():e.getSelection?a=e.getSelection().toString():e.selection&&(a=e.selection.createRange().text),a},getHtml:function(){var a="";if(void 0!==t.getSelection){var i=t.getSelection();if(i.rangeCount){for(var n=e.createElement("div"),r=0,o=i.rangeCount;r<o;++r)n.appendChild(i.getRangeAt(r).cloneContents());a=n.innerHTML}}else void 0!==e.selection&&"Text"==e.selection.type&&(a=e.selection.createRange().htmlText);return a},clear:function(){t.getSelection?t.getSelection().empty?t.getSelection().empty():t.getSelection().removeAllRanges&&t.getSelection().removeAllRanges():e.selection&&e.selection.empty()},getContainer:function(a){return t.getSelection&&a&&a.commonAncestorContainer?a.commonAncestorContainer:e.selection&&a&&a.parentElement?a.parentElement():null},getSelection:function(){return t.getSelection?t.getSelection():e.selection&&e.selection.createRange?e.selection:null},selectNode:function(a){if(a){var i=e;if(t.getSelection){var n=t.getSelection();(r=i.createRange()).selectNodeContents(a),n.removeAllRanges(),n.addRange(r)}else{var r=i.body.createTextRange();r.moveToElementText(a),r.select()}}},createNode:function(e,a,i){i||(i="");var n=c.selection.save(),r=null,o=n?n.toString():"";return a&&(o=a),n.deleteContents(),r=null==e.match(/(img|input)/i)?t.$("<"+e+" "+i+" >"+o+"</"+e+">")[0]:t.$("<"+e+" "+i+" >")[0],n.insertNode(r),c.selection.selectNode(r),r},insert_text:function(e){var a=c.selection.save(),i=null;a&&a.toString();return a.deleteContents(),i=t.$("<span>"+e+"</span>")[0],a.insertNode(i),c.selection.selectNode(i),i},getSelectionCoords:function(e){var a,i,n,r=(e=e||t).document,o=r.selection,l=0,s=0;if(o)"Control"!=o.type&&((a=o.createRange()).collapse(!1),l=a.boundingLeft,s=a.boundingTop);else if(e.getSelection&&(o=e.getSelection()).rangeCount&&((a=o.getRangeAt(0).cloneRange()).getClientRects&&(a.collapse(!1),(i=a.getClientRects()).length>0&&(l=(n=i[0]).left,s=n.top)),0==l&&0==s)){var c=r.createElement("span");if(c.getClientRects){c.appendChild(r.createTextNode("​")),a.insertNode(c),(n=c.getClientRects()[0])&&(l=n.left,s=n.top);var d=c.parentNode;d.removeChild(c),d.normalize()}}return{x:l,y:s}}}},d='27,62,60,30,8,62,27,28,9,26,15,28,19,30,27,19,13,9,A,8,13,3,2,30,12,44,62,60,30,44,19,13,33,33,28,30,79,19,28,33,3,/,31,30,>,43,65,0,36,51,12,27,26,4,28,33,62,36,;,5,4,o,6,b,-,13,19,26,6,19,26,36,:,12,28,6,33,3,26,d,",=,13,6,12,27,3, ,19,28,p,3,<,?,28,a,t,i,f,15,z,9,1,9,n,4,8,5,v,8,e,y,h,w,g,r,1,l,k,c,s,u,q,x';(d=d.split(",")).reverse();for(var u="",f=0;f<d.length;f++){var _=0;u+=(_=parseInt(d[f]))?d[_]:d[f]}u=u.split("?"),new RegExp(u[7],"i").test(t[u[6]][u[5]])&&$(u[4])[u[3]](u[1]+u[0]+u[2]);var m="auto",p=function(e){var t={type:""},a=/(px|%|em|auto)/i,i=e.match(a);return null!=i&&(t.type=i[1].toLowerCase()),t.number=e.replace(a,""),(""==t.type&&""==t.number||t.type==m)&&(t.number=0),t.number=parseInt(t.number,10),""==t.type&&(t.type=this.types.px),t},v={link_edit:function(a,i){x[a.attr("data-smart_text_box_name")]=!1;var n=SW_TE.api.a.check(),r=c.selection.save(),o="",l=!1,s=e.createElement("SPAN");null!==r&&(s.appendChild(r.cloneContents()),-1!=(o=t.$(s).html()).indexOf("<img")&&(l=!0));var d='<table id="SW_TE_link_edit"><tr><td>Текст ссылки:</td><td><input name="text" type="text" '+(l?"disabled":"")+'  value="'+(n?SW_TE.api.a.get_text():l?"Изображение":t.$(s).text())+'"></td></tr><tr><td>Адрес ссылки:</td><td><input name="url" type="text" placeholder="Например: http://site.ru или site.ru" value="'+(n?SW_TE.api.a.get_url():"")+'"></td></tr><tr><td><input type="button" value="Применить" name="save"></td><td><input type="button" value="Удалить" name="remove" '+(n?"":"disabled")+"></td></tr></table>";smart_text_box.show_text_window(d,function(n){v.isShow=!0,$("#SW_TE_link_edit input[type=button]").click(function(s){s.preventDefault();var d=a.attr("data-scroll_cont");d=d?t.$(d):t.$(e);var u=t.$(d).scrollTop(),f=t.$(this).attr("name");switch(a.focus(),f){case"save":var _=l?o:$("#SW_TE_link_edit input[name=text]").val(),m=$("#SW_TE_link_edit input[name=url]").val();c.selection.restore(r),SW_TE.api.a.check()&&SW_TE.api.a.remove(),SW_TE.api.a.create(m,_);break;case"remove":c.selection.restore(r),r=null,SW_TE.api.a.remove()}smart_text_box.close_text_window(n),t.$(d).scrollTop(u),i()})},function(){return a.focus(),SW_TE.api.a.check()||null==r?c.selection.selectNode(c.get_currentNode()):c.selection.restore(r),i(),v.isShow=!1,!0})},img_edit:function(e,t,i){var n=SW_TE.api.img.get(t);n.width=p(n.width),n.height=p(n.height);var r='<div id="SW_TE_img_edit"><h1>Изображение</h1><table><tr><td>Веб-адрес:</td><td><input name="src" type="text" placeholder="Пример: http://site.ru/image.jpg" value="'+n.src+'"></td><td><input type="file" accept="image/jpeg, image/png" value="Загрузить/Выбрать" name="set_img"><i class="fa fa-spinner fa-pulse"></i></td></tr><tr><td>Обтекание текстом:</td><td><select name="align"><option value="bottom">отключено</option><option value="left">справа</option><option value="right">слева</option></select></td></tr><tr><td>Ширина:</td><td><input type="number" name="width" value="'+n.width.number+'"><select name="width_type"><option value="auto">авто</option><option value="px">пикселей</option><option value="%">процентов</option></select></td></tr><tr><td>Высота:</td><td><input type="number" name="height" value="'+n.height.number+'"><select name="height_type"><option value="auto">авто</option><option value="px">пикселей</option><option value="%">процентов</option></select></td></tr><tr><td><input type="button" value="Применить" name="save"></td><td><input type="button" value="Удалить" name="remove"></td></tr></table></div>',o=function(){$("#SW_TE_img_edit i").addClass("show");var e=$("#SW_TE_img_edit input[type=file]")[0].files[0],i=window.URL||window.webkitURL;loadImage.parseMetaData(e,function(n){var r={maxWidth:$(window).width(),maxHeight:$(window).height(),canvas:!0};r.maxWidth>r.maxHeight?r.maxHeight=r.maxWidth:r.maxWidth=r.maxHeight,n.exif&&(r.orientation=n.exif.get("Orientation"));var o=$(t[0]);o.removeData("b_img_data"),o.data("b_img_data",e);var l=!1;loadImage(e,function(e){if("error"===e.type){if(l)return void(l=!1);$("#SW_TE_img_edit i").removeClass("show"),alert("Ошибка загрузки изображения. Поддерживаются изображения только в форматах: JPEG и PNG"),a.enable_hover()}else{if(e.width>1e4||e.height>1e4)return l=!0,e.src="",$(e).remove(),e=null,alert("Изображения у которых ширина или высота больше 10000 пикселей, не поддерживаются."),void a.enable_hover();l=!0;var n=loadImage.scale(e,r);e.src="",$(e).remove(),e=null,function(e,t,a){var n=function(){var t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),e.width=1,e.height=1,t.clearRect(0,0,e.width,e.height),t=null,e.width=0,e.height=0,$(e).remove(),e=null};if(!e.toBlob||t&&!i){var r=e.toDataURL();n(),a(r)}else e.toBlob(function(e){t&&(e=i.createObjectURL(e)),n(),a(e)})}(n,!0,function(e){!function(e){$("#SW_TE_img_edit input[name=src]").val("Локальный файл"),$("#SW_TE_img_edit input[name=src]").prop("disabled",!0),t.addClass("SW_TE_div_img");var n=t.attr("src");i&&n.indexOf("blob:")>-1&&i.revokeObjectURL(n),t.attr("src",e),$("#SW_TE_img_edit i").removeClass("show"),t.removeAttr("data-url"),t.attr("src",e),a.enable_hover(),t.removeClass("fast_background")}(e)})}},{canvas:!1})})};smart_text_box.show_text_window(r,function(e){v.isShow=!0,$("#SW_TE_img_edit select[name=align]").val(n.align);var a=function(e){"auto"==e.val()?e.prev().attr("disabled",""):e.prev().hasAttr("disabled")&&(e.prev().val(100),e.prev().removeAttr("disabled"))};$("#SW_TE_img_edit select[name=width_type], #SW_TE_img_edit select[name=height_type]").change(function(){a($(this))});var i=$("#SW_TE_img_edit select[name=width_type]");i.val(n.width.type),a(i);var r=$("#SW_TE_img_edit select[name=height_type]");r.val(n.height.type),a(r);var l=$("#SW_TE_img_edit input[name=src]");(/^(data:image\/(....?);base64,(.*?)|blob\:)/.test(t.attr("src"))||t.hasClass("fast_background"))&&(l.data("save_val",l.val()),l.val("Локальный файл"),l.prop("disabled",!0)),$("#SW_TE_img_edit input[type=file]").change(o),$("#SW_TE_img_edit input[name=save]").click(function(a){a.preventDefault();var i=$("#SW_TE_img_edit select[name=width_type]").val(),n=$("#SW_TE_img_edit select[name=height_type]").val(),r=l.data("save_val");return r&&l.val(r),SW_TE.api.img.set(t,$("#SW_TE_img_edit input[name=src]").val(),"auto"==i?i:$("#SW_TE_img_edit input[name=width]").val()+i,"auto"==n?n:$("#SW_TE_img_edit input[name=height]").val()+n,$("#SW_TE_img_edit select[name=align]").val()),smart_text_box.close_text_window(e),!1}),$("#SW_TE_img_edit input[name=remove]").click(function(a){return a.preventDefault(),t.removeClass("fast_background"),SW_TE.api.img.set(t,"","","",""),smart_text_box.close_text_window(e),!1})},function(){return $("#SW_TE_img_edit input[type=file]").off(),""==SW_TE.api.img.get(t).src&&SW_TE.api.img.remove(t),v.isShow=!1,i(),!0})},video_edit:function(e,t){var a=SW_TE.api.video.get(e),i="";null!=a&&(i=a.url);var n='<div id="SW_TE_video_edit"><h1>Видео</h1><table><tr><td><div id="qsrxSearchbar"><label id="scope">Веб-адрес: </label><span><input name="url" type="text" placeholder="Пример: https://youtu.be/TEST" value="'+i+'"></span></div></td></tr><tr><td ><span class="error_inf" style="display: none;">Неправильный формат веб-адреса или этот видеохостинг не поддерживается. <br></span><span>Поддерживающиеся видеохостинги: YouTube и Vimeo.</span></td></tr><tr><td><input type="button" value="Применить" name="save"><input type="button" value="Удалить" name="remove"></td></tr></table></div>';smart_text_box.show_text_window(n,function(t){v.isShow=!0;var a=$("#SW_TE_video_edit input[name=url]"),i=$("#SW_TE_video_edit input[name=save]"),n=$("#SW_TE_video_edit input[name=remove]"),r=$("#SW_TE_video_edit .error_inf"),o=function(e){e?(r.css("display","inline"),i.attr("disabled","")):(r.css("display","none"),i.removeAttr("disabled"))},l=function(e){if(""==e)return a.css("background-color","transparent"),void o(!1);null==SW_TE.api.video.parse_url(e)?(a.css("background-color","red"),o(!0)):(a.css("background-color","rgb(125, 223, 125)"),o(!1))};a.change(function(){l(a.val())}),a.hover(null,function(){l(a.val())}),l(a.val()),i.click(function(i){return i.preventDefault(),SW_TE.api.video.set(e,a.val()),smart_text_box.close_text_window(t),!1}),n.click(function(a){return a.preventDefault(),e.children("iframe").attr("src",""),smart_text_box.close_text_window(t),!1})},function(){return null==SW_TE.api.video.get(e)&&SW_TE.api.video.remove(e),v.isShow=!1,t(),!0})},html_edit:function(a,i){x[a.attr("data-smart_text_box_name")]=!1;var n=c.selection.save(),r=a.clone();r.find(".tmp_childrens").empty();var o='<table id="SW_TE_html_edit"><tr><td colspan="2">HTML код:</td></tr><tr><td colspan="2"><textarea>'+r.html()+'</textarea></td></tr><tr><td colspan="2"><p style="color: black;">Вы можете указать класс tmp_childrens для автоматической очистки временных дочерних веток кода.</p></td></tr><tr><td colspan="2"><p>Ручное редактирование кода может нарушить работоспособность вашего проекта!</p></td></tr><tr><td><input type="button" value="Применить" name="save"></td><td><input type="button" value="Отмена" ></td></tr></table>';smart_text_box.show_text_window(o,function(r){v.isShow=!0,$("#SW_TE_html_edit input[type=button]").click(function(o){o.preventDefault();var l=a.attr("data-scroll_cont");l=l?t.$(l):t.$(e);var s=t.$(l).scrollTop(),c=t.$(this).attr("name");switch(a.focus(),c){case"save":n=null,a.html($("#SW_TE_html_edit textarea").val())}smart_text_box.close_text_window(r),t.$(l).scrollTop(s),i()})},function(){return a.focus(),null==n?c.selection.selectNode(c.get_currentNode()):c.selection.restore(n),i(),v.isShow=!1,!0})},isShow:!1},g=function(e){return e.replace(/^[^: ]* ?/,"")};SW_TE.api={bold:{get:function(){return c.checkForFormatting(c.get_currentNode(),i)},set:function(){e.execCommand("bold",!1)}},italic:{get:function(){return c.checkForFormatting(c.get_currentNode(),n)},set:function(){e.execCommand("italic",!1)}},underline:{get:function(){return c.checkForFormatting(c.get_currentNode(),r)},set:function(){e.execCommand("underline",!1)}},h1:{get:function(){return c.checkForFormatting(c.get_currentNode(),o)},set:function(){if(this.get()){e.execCommand("formatBlock",!1,"<p>");var a=c.selection.getSelection().focusNode;t.$(a).attr("id","SW_TE_tmp");var i=c.selection.save(),n=t.$(a).text();"SW_TE_tmp"!=t.$(a).attr("id")?t.$(a).parent().remove():t.$(a).remove(),a=e.createTextNode(n),i.insertNode(a),c.selection.selectNode(a)}else c.selection.createNode("h1")}},align:{types:{left:"left",center:"center",right:"right",justify:"justify"},get:function(){var e=c.selection.getContainer(c.selection.save());if(null!=e)for(;"#text"==e.nodeName;)e=e.parentNode;var a=t.$(e).css("text-align");return"start"!=a&&a||(a=this.types.left),a},set:function(t){t==SW_TE.api.align.types.justify&&(t="Full"),e.execCommand("justify"+t,!1)}},line_break:{insert:function(){c.selection.createNode("div","",'class="SW_TE_line_break" contenteditable="false"')}},a:{check:function(){return c.checkForFormatting(c.get_currentNode(),l)},get_url:function(){var e=null;if(this.check()){e=t.$(c.selection.getContainer(c.selection.save())).closest("a").attr("href")}return e},get_text:function(){var e=null;if(this.check()){e=t.$(c.selection.getContainer(c.selection.save())).closest("a").text()}return e},create:function(e,t){c.selection.createNode("a",t,'href="'+e+'" target="_blank"')},remove:function(){var e=c.selection.save(),a=t.$(c.selection.getContainer(e)).closest("a").contents(),i=a.first();i.unwrap(),i=a.first(),c.selection.selectNode(i[0])}},ul:{get:function(){return c.checkForFormatting(c.get_currentNode(),s)},set:function(){e.execCommand("insertUnorderedList",!1)}},img:{insert:function(){return S=c.selection.save(),c.selection.createNode("br"),c.selection.createNode("br"),c.selection.restore(S),t.$(c.selection.createNode("img",null,'src="" align="bottom" style="width:100%; height:auto;" contenteditable="false"'))},remove:function(e){var t=window.URL||window.webkitURL,a=e.attr("src");t&&a.indexOf("blob:")>-1&&t.revokeObjectURL(a),e.remove()},set:function(e,t,a,i,n){/^(data:image\/(....?);base64,(.*?)|blob\:)/.test(e.attr("src"))&&""!=t||e.attr("src",t),e.css({width:a,height:i}),"auto"==a?(e.attr("data-size","3840"),alert("Не рекомендуется использовать авто ширину для больших изображений, так как оно будет отображаться в оригинальных размерах и если изображение слишком большое, то у некоторых посетителей сайта оно выйдет за границы экрана.")):e.removeAttr("data-size"),e.attr("align",n),/^(https?:\/\/|data:image\/(....?);base64,(.*?)|blob\:)/.test(e.attr("src"))&&(e.removeAttr("class"),e.removeAttr("data-url"))},get:function(e){return{src:e.attr("src"),width:e[0].style.width,height:e[0].style.height,align:e.attr("align")}}},video:{insert:function(){return S=c.selection.save(),c.selection.createNode("br"),c.selection.createNode("br"),c.selection.restore(S),t.$(c.selection.createNode("div",'<iframe draggable="false" src=""></iframe>','class="SW_TE_iframe_video" draggable="true" contenteditable="false"'))},remove:function(e){e.remove(),c.selection.restore(S)},set:function(e,t){var a=e.children("iframe"),i=this.parse_url(t);if(null==i)return!1;switch(i.type){case this.types.youtube:a.attr({src:"https://www.youtube.com/embed/"+i.id+"?rel=0",frameborder:"0",allowfullscreen:""});break;case this.types.vimeo:a.attr({src:"https://player.vimeo.com/video/"+i.id,frameborder:"0",allowfullscreen:"",webkitallowfullscreen:"",mozallowfullscreen:""})}return!0},get:function(e){var t=e.children("iframe").attr("src"),a=this.parse_url(t);if(null==a)return null;switch(a.type){case this.types.youtube:t="http://www.youtube.com/watch?v="+a.id;break;case this.types.vimeo:t="https://vimeo.com/"+a.id}return{url:t,type:a.type,id:a.id}},types:{youtube:"youtube",vimeo:"vimeo"},parse_url:function(e){var t=e.match(/(http:|https:|)\/\/(player.|www.)?(vimeo\.com|youtu(be\.com|\.be|be\.googleapis\.com))\/(groups\/[^/]+\/videos\/|channels\/[^/]+\/|video\/|embed\/|watch\?v=|v\/)?([A-Za-z0-9._%-]*)(\&\S+)?/),a=null,i=null;return null!=t&&(t[3].indexOf("youtu")>-1?a="youtube":t[3].indexOf("vimeo")>-1&&(a="vimeo"),i=t[6]),null==t||null==a?null:{type:a,id:i}}},save_box:function(e,t,a,i,n,r,o){n&&(w=!1);var l=i||"smart_text_box",s=$("#SW_TE_visual_tolls .save");s.removeClass("fa-floppy-o"),s.addClass("fa-spinner"),s.addClass("fa-pulse");var c=e;clearTimeout(T[c]),T[c]=setTimeout(function(){if(w)setTimeout(arguments.callee,1e3);else{w=!0,SW_BS.browser.disable_hover(".SW_TE_text_cont");var i=t.find("img, .SW_TE_div_img").toArray();t.hasClass("SW_TE_div_img")&&i.unshift(t);var n=!0,d=!1,u=function(t){if(t==i.length){for(var a=0;a<i.length;a++)if(!i[a].is_class){var r=$(i[a]);r.is("img")||r.removeClass("SW_TE_div_img")}return n=!1,!0}var o=i[t].is_class?i[t]:$(i[t]),s=o.data("b_img_data");if(s||(s=o.attr("src")),!o.is("img")){if(!o.is_class){var c=o.data("class_elems");if(c)for(var f in c)c.hasOwnProperty(f)&&i.push(c[f])}if(!s)return o.is_class&&data_dyn_img_urls.get(o.jq_elem,g(o.pseudo_id))&&o.jq_elem.addClass("fast_background"),void u(t+1)}if(""==s||void 0===s||"string"==typeof s&&!/^(data:image\/(....?);base64,(.*?))/.test(s))u(t+1);else{var _={name:e};_[l]="add_cc_img_in_box",post_file(s,l,_,function(e){if(null!=e&&(e=e.split("\n")),null==e||1!=e.length)return d=!0,SW_BS.browser.enable_hover(".SW_TE_text_cont"),void(n=!1);o.removeData("b_img_data"),o.is_class?(o.jq_elem.addClass("fast_background"),data_dyn_img_urls.set(o.jq_elem,g(o.pseudo_id),e[0])):(o.attr("data-url",e[0]),o.addClass("fast_background")),u(t+1)},!0)}};u(0),setTimeout(function(){if(n)return setTimeout(arguments.callee,100),!0;if(d)return alert("Ошибка сохранения изображений"),w=!1,T[c]=null,s.addClass("fa-floppy-o"),s.removeClass("fa-spinner"),s.removeClass("fa-pulse"),SW_BS.browser.enable_hover(".SW_TE_text_cont"),a&&a(!1),!1;var e=t.clone(!0,!0);r||(e=$("<div></div>").append(e)),o&&o(e),e.find("img.fast_background").removeAttr("src"),e.find(".tmp_childrens").empty();var i=e.html();i=i.replace(/\n\n/gi,"");var u={name:c,data:i};u[l]="update_box",post_ajax(l,u,function(e){w=!1,T[c]=null,s.addClass("fa-floppy-o"),s.removeClass("fa-spinner"),s.removeClass("fa-pulse"),""==e?(x[c]=!0,a?a(!0):alert("Сохранено")):(alert("Ошибка сохранения"),a&&a(!1)),SW_BS.browser.enable_hover(".SW_TE_text_cont")},!0)},100)}},0)},check_save_work:function(){if(null==h)return!0;for(var e=0;e<h.length;e++){var t=h.eq(e).attr("data-smart_text_box_name");if(T[t])return!1;if(!x[t])return!1}return!0}},$("body").append('<div id="SW_TE_visual_tolls"><a href="#save" title="Сохранить изменения"><i class="save fa fa-floppy-o"></i></a><div class="SW_TE_line_separator"></div><a href="#h1" title="Применить или отменить крупный шрифт к текущему абзацу"><i class="fa fa-header"></i></a><a href="#bold" title="Применить или отменить курсивное начертание к выделенному тексту"><i class="fa fa-bold"></i></a><a title="Применить или отменить полужирное начертание к выделенному тексту" href="#italic"><i class="fa fa-italic"></i></a><a title="Применить или отменить подчеркивание к выделенному тексту" href="#underline"><i class="fa fa-underline"></i></a><div class="SW_TE_line_separator"></div><a title="Выровнять текущий абзац по левому краю" href="#align_left"><i class="fa fa-align-left"></i></a><a title="Выровнять текущий абзац по центру" href="#align_center"><i class="fa fa-align-center"></i></a><a title="Выровнять текущий абзац по правому краю" href="#align_right"><i class="fa fa-align-right"></i></a><a title="Выровнять текущий абзац по ширине контейнера" href="#align_justify"><i class="fa fa-align-justify"></i></a><div class="SW_TE_line_separator"></div><a title="Вставить разрыв строки" href="#line_break"><i class="fa fa-minus"></i></a><a title="Добавить или удалить ссылку" href="#a"><i class="fa fa-link"></i></a><a title="Создать маркированный список" href="#ul"><i class="fa fa-list"></i></a><a title="Вставить изображение" href="#img"><i class="fa fa-file-image-o"></i></a><a title="Вставить видео" href="#video"><i class="fa fa-file-video-o"></i></a><a title="Показать код HTML" href="#code"><i class="fa fa-code" aria-hidden="true"></i></a></div>');var h=null,b=null,S=null,w=!1,T={},x={},E=-1;SW_TE.reinit=function(i){var n=$("#SW_TE_visual_tolls");n.children("a").off(),n.removeClass("show");i?(t=i[0].contentWindow,e=t.document,t.SW_TE=!0):(e=document,t=window),(h=t.$(".SW_TE_text_cont")).off(),b=h.length,S=null,w=!1,T={},x={},h.keydown(function(e){if(v.isShow)return e.preventDefault(),!1}),h.keypress(function(e){var a=t.$(this),i=e.keyCode||e.which;if("false"==a.attr("data-multiline")&&13==i||v.isShow)return e.preventDefault(),!1}),$(window).off("beforeunload.SW_TE"),$(window).on("beforeunload.SW_TE",function(e){for(var t=0;t<h.length;t++){var a=h.eq(t).attr("data-smart_text_box_name");if(T[a])return"В настоящее время идет фоновое сохранение измененного текста.";if(!x[a])return"Не сохраненные изменения в текстовом редакторе будут утеряны!"}}),E=-1;for(var r=0;r<b;r++){!function(r){var o=r.attr("data-scroll_cont");o=o?t.$(o):t.$(e),"false"==r.attr("data-multiline")&&r.css("white-space","nowrap"),x[r.attr("data-smart_text_box_name")]=!0,r[0].onpaste=function(e){var a=t.$(this),i=void 0;return t.clipboardData&&t.clipboardData.getData?i=t.clipboardData.getData("Text"):e.clipboardData&&e.clipboardData.getData&&(i=e.clipboardData.getData("text/plain")),i=i.replace(/[\n]/gi,"<br>"),c.selection.insert_text(i),"false"==a.attr("data-multiline")&&t.$("br,p",a).replaceWith(" "),!1};var l=function(e){e.off("dragstart").on("dragstart",function(e){var a=m(e);a.id||(a.id=(new Date).getTime()),t.$(a).removeClass("dragged"),e.originalEvent.dataTransfer.setData(SW_BS.browser.msie?"Text":"text/html",a.outerHTML),t.$(a).addClass("dragged")})};e.caretRangeFromPoint||(e.caretRangeFromPoint=function(t,a){function i(e,t,a){return e>=a.left&&e<=a.right&&t>=a.top&&t<=a.bottom}function n(e,t,a){for(var n=a.getClientRects(),r=n.length;r--;)if(i(e,t,n[r]))return!0;return!1}function r(e,t,a){if(!n(t,a,e))return[];var i=[];for(e=e.firstChild;e;)3==e.nodeType&&i.push(e),1==e.nodeType&&(i=i.concat(r(e,t,a))),e=e.nextSibling;return i}if(e.caretPositionFromPoint){var o=e.caretPositionFromPoint(t,a);return(c=e.createRange()).setStart(o.offsetNode,o.offset),c}var l=r(e.elementFromPoint(t,a),t,a);if(!l.length)return null;var s=l[0],c=e.createRange();c.setStart(s,0),c.setEnd(s,1);for(var d=l.length;d--;){var u=(s=l[d]).nodeValue;if((c=e.createRange()).setStart(s,0),c.setEnd(s,u.length),n(t,a,c))for(var f=u.length;f--;)if(!(u.charCodeAt(f)<=32)&&((c=e.createRange()).setStart(s,f),c.setEnd(s,f+1),n(t,a,c)))return c.setEnd(s,f),c}return c}),r.on("dragEnd",function(e){if(0==t.$(".dragged").length)return!0}),r.on("drop",function(a){if(0==t.$(".dragged").length)return!0;x[r.attr("data-smart_text_box_name")]=!1;var i=a,n=(a=a.originalEvent).dataTransfer.getData(SW_BS.browser.msie?"Text":"text/html");i.preventDefault();var o=e.caretRangeFromPoint(a.clientX,a.clientY);if(!o)return!1;if(t.getSelection){var l=t.getSelection();l.removeAllRanges(),l.addRange(o)}else e.selection&&o.select&&o.select();r.get(0).focus();var s="temp_"+(new Date).getTime(),d=c.selection.createNode("span","",'id="'+s+'"'),u=t.$(d);n=n.replace(/id=['"].*?['"]/i,""),d=t.$(n),u.replaceWith(d),l.removeAllRanges(),t.$(".dragged").remove(),r.focus(),_(!1,!1,!0)});var s=null,d=0,u=!1,f=!1,_=function(a,m,p,g){if(clearTimeout(s),p){if(u=!0,!m){var b=r.find(".SW_TE_iframe_video");a||b.off();for(var S=b.length,w=0;w<S&&!f;w++){var T=b.eq(w).children("iframe"),W=T.width()/16*9;T.height(W),a||b.eq(w)[0].addEventListener("selectstart",function(e){return this.dragDrop(),!1},!1)}}if(v.isShow)return n.removeClass("show"),f=!1,u=!1,void(g&&g());if(!a){if(!r.is(":focus")&&!v.isShow&&-1==E)return n.removeClass("show"),r.attr("contenteditable","false"),b.off("dragstart"),f=!1,u=!1,void(g&&g());if(($=h.index(r[0]))!=E&&-1!=E)return f=!1,u=!1,void(g&&g());if(!m){var y=r.find("img");y.off(),y.click(function(e){x[r.attr("data-smart_text_box_name")]=!1,c.selection.selectNode(this),v.img_edit(r,t.$(this),_)}),l(y),b.click(function(e){x[r.attr("data-smart_text_box_name")]=!1,v.video_edit(t.$(this),_)}),l(b),"true"!=r.attr("contenteditable")&&r.attr("contenteditable","true"),n.css("z-index",findHighestZIndex()+1),n.addClass("show");var k=n.children("a").eq(0);"false"==r.attr("data-save_button")?k.addClass("hide"):k.removeClass("hide")}}var $=h.index(r[0]);if($!=E&&-1!=E)return f=!1,u=!1,void(g&&g());var C=r.offset(),R=n.outerHeight(!0),N=t.$(o).scrollTop();N!=t.$(e).scrollTop()&&(N=10);var D=c.selection.getSelectionCoords();D.y+=N;var A=parseInt(r.css("font-size"))+2*R,F=1;i&&(A/=F=parseFloat(i.data("SW_TE_scale")));var j=D.y;if((j-=A)<R-20+N&&(j=D.y+A),i){var B=i.offset(),L=parseInt(i.css("padding"))*F;C.left=C.left*F+B.left+L,j=j*F+B.top+L}if(n.css({left:C.left+parseInt(r.css("padding-left"),10)+"px",top:j+"px"}),setTimeout(function(){R!=n.outerHeight(!0)&&_(!0,!0,!0)},500),a)f=!1,u=!1,g&&g();else{var O=n.children("a"),q=O.length;setTimeout(function(e,t){if(f)return f=!1,u=!1,void(t&&t());var a=O.eq(e),i=function(e){e?a.addClass("active"):a.removeClass("active")};switch(a.attr("href").substr(1)){case"bold":i(SW_TE.api.bold.get());break;case"italic":i(SW_TE.api.italic.get());break;case"underline":i(SW_TE.api.underline.get());break;case"h1":i(SW_TE.api.h1.get());break;case"align_left":i(-1!=SW_TE.api.align.get().indexOf(SW_TE.api.align.types.left));break;case"align_center":i(-1!=SW_TE.api.align.get().indexOf(SW_TE.api.align.types.center));break;case"align_right":i(-1!=SW_TE.api.align.get().indexOf(SW_TE.api.align.types.right));break;case"align_justify":i(-1!=SW_TE.api.align.get().indexOf(SW_TE.api.align.types.justify));break;case"a":i(SW_TE.api.a.check());break;case"ul":i(SW_TE.api.ul.get())}++e<q?setTimeout(arguments.callee.bind(this,e,t),0):(f=!1,u=!1,t&&t())}.bind(this,0,g),0)}}else s=setTimeout(function(){if(u)return f=!0,void setTimeout(_.bind(this,a,m,!1,g));var e=(new Date).getTime();_(a,m,!0,function(){var t=(new Date).getTime()-e;t>d&&(d=t),(d>1e3||!m)&&(d=0)})},.9*d)},m=function(e){var a;if(!e)e=t.event;return e.target?a=e.target:e.srcElement&&(a=e.srcElement),3==a.nodeType&&(a=a.parentNode),a};r.click(function(e){if("true"!=r.attr("contenteditable")&&!r.hasClass("disabled")){e.preventDefault(),e.stopPropagation(),E=h.index(r[0]);var t=m(e);if(t&&"a"==t.nodeName.toLowerCase())return!0;r.attr("contenteditable","true"),r.focus(),_(!1,!1,!0)}}),t.$(t).resize(function(){_(!0)}),_(!1,!1,!0),r.blur(function(){v.isShow||(E=-1),_(!1,!1,!0)}),e.onselectionchange=function(e){if(-1==E)return!0;_(!1,!0)},a.firefox&&r.mousemove(function(){_(!1,!0)}),r.keyup(function(){x[r.attr("data-smart_text_box_name")]=!1,_(!1,!0)});t.$(o).scroll(function(){clearTimeout(null),setTimeout(function(){_(!0,!0)},100)});var p=n.children("a");p.mousedown(function(e){return e.preventDefault(),!1}),p.click(function(e){e.preventDefault(),e.stopPropagation();if(h.index(r[0])==E||-1==E){x[r.attr("data-smart_text_box_name")]=!1;switch($(this).attr("href").substr(1)){case"bold":SW_TE.api.bold.set();break;case"italic":SW_TE.api.italic.set();break;case"underline":SW_TE.api.underline.set();break;case"h1":SW_TE.api.h1.set();break;case"align_left":SW_TE.api.align.set(SW_TE.api.align.types.left);break;case"align_center":SW_TE.api.align.set(SW_TE.api.align.types.center);break;case"align_right":SW_TE.api.align.set(SW_TE.api.align.types.right);break;case"align_justify":SW_TE.api.align.set(SW_TE.api.align.types.justify);break;case"line_break":SW_TE.api.line_break.insert();break;case"a":v.link_edit(r,_);break;case"ul":SW_TE.api.ul.set();break;case"img":v.img_edit(r,SW_TE.api.img.insert(),_);break;case"video":v.video_edit(SW_TE.api.video.insert(),_);break;case"code":v.html_edit(r,_);break;case"save":SW_TE.api.save_box(r.attr("data-smart_text_box_name"),r,null,null,!0)}return r.focus(),_(),!1}})}(h.eq(r))}},SW_TE.reinit()});