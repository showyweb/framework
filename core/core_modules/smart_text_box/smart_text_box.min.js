/**
 * Name:    SHOWYWEB SMART TEXT BOX
 * Version: 1.0.0 (11.10.2016)
 * Author:  Novojilov Pavel Andreevich
 * Support: http://SHOWYWEB.ru
 * License: Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0) https://creativecommons.org/licenses/by-nc-nd/4.0/
 */
var smart_text_box={global_callback_close:null,reinit:function(){setTimeout(smart_text_box.reinit,100)}};$(document).ready(function(){SW_BS.browser;smart_text_box.reinit=function(){function t(t,n,o){clearTimeout(a[t]),a[t]=setTimeout(function(){if(e)setTimeout(arguments.callee,1e3);else{e=!0;for(var r=i.length,s=0;s<r;s++)i.eq(s).parent().attr("data-smart_text_box_name")==t&&n!=i.eq(s).html()&&i.eq(s).html(n);if(n==l)return e=!1,void(a[t]=null);post_ajax("smart_text_box",{smart_text_box:"update_box",name:t,data:n},function(i){e=!1,a[t]=null,""==i&&alert("Сохранено"),o&&o()},!0)}},0)}for(var e=!1,a={},i=$('.smart_text_box>span:first-child[data-contenteditable="true"]'),n=0;n<i.length;n++){var o=i.eq(n);"false"==o.attr("data-multiline")&&o.css("white-space","nowrap"),o.parent().children(".save").remove(),o[0].onpaste=function(t){var e=$(this);setTimeout(function(){var t=e.text();e.text(t),"false"==e.attr("data-multiline")&&$("br,p",e).replaceWith(" ")},100)};var r=o.parent().attr("data-smart_text_box_name");a[r]=null}$(window).off("beforeunload.smart_text_box"),$(window).on("beforeunload.smart_text_box",function(t){for(var e=!1,n=0;n<i.length;n++){var o=i.eq(n).parent().attr("data-smart_text_box_name");if(a[o]){e=!0;break}}if(e)return"В настоящее время идет фоновое сохранение измененного текста."});var s=null,l=null,d=!1;i.off(),i.click(function(t){var e=$(this);"modal"!=e.attr("data-editor")?e.hasClass("disabled")||e.parent().hasClass("disabled")||(t.preventDefault(),t.stopPropagation(),"true"!=e.attr("contenteditable")&&(e.attr("contenteditable","true"),e.focus(),s=e.parent().attr("data-smart_text_box_name"),l=e.html(),e.focus(),d=!1)):smart_text_box.show_text_window(e.parent().parent().html(),function(){(e=$(".text_window .smart_text_box span")).removeAttr("data-editor")},function(){return smart_text_box.reinit(),!0},!0)}),i.blur(function(){var e=$(this);setTimeout(function(){e.removeAttr("contenteditable"),e.parent().children(".save").remove(),e.parent().removeClass("focus"),e.parent().css({"padding-right":0}),d||"false"==e.attr("data-save_button")||t(s,l)},100)}),i.keypress(function(t){var e=$(this),a=t.keyCode||t.which;if("false"==e.attr("data-multiline")&&13==a)return t.preventDefault(),!1}),i.keyup(function(e){var a=$(this);if(a.html()!=l&&"false"!=a.attr("data-save_button")&&!a.parent().hasClass("focus")){a.parent().addClass("focus");var i=parseInt(a.css("font-size"))+10;a.parent().css({"padding-right":i+"px"}),a.parent().append('<a class="save" title="Сохранить"><i class="fa fa-floppy-o"></i></a>');$(".smart_text_box .save").mousedown(function(e){return d=!0,e.stopPropagation(),e.preventDefault(),t(s,a.html(),function(){a.blur()}),!1})}})};var t={},e={};smart_text_box.show_text_window=function(a,i,n,o,r,s){$("body").append('<div class="text_window" style="z-index: '+(findHighestZIndex($("body").children("*").eq(0))+1)+';"><div><div><div><a class="close_text_window" title="Закрыть" href="#"><i class="fa fa-times"></i></i></a><div><div></div></div></div></div></div></div>');var l=a,d=0,_=$(".text_window>div>div>div>div"),c=_.length-1;_=_.eq(c),void 0!==s&&_.parent().css("width",s),t[c]=n,_.children("*").html(l),$(".text_window>div").eq(c).css({visibility:"visible",display:"table",top:0});var x=function(){d=$(window).height()-110};x(),$(window).resize(x);var f={};smart_text_box.scoll_tw_reinit=function(t){var e=$(".text_window").eq(t).find(".stb_iframe");e.is("iframe")&&null!=e[0].contentWindow.document.body&&(e[0].height=d,e[0].width=e.parent().width());var a=$(".text_window>div>div>div>div").eq(t);if(a.children("*").height()>=d){if(f[t])return!1;f[t]=!0,a.css({height:d+"px",display:"block"}),(0==a.find("iframe").length||r)&&a.css("overflow-y","auto"),"true"!=a.attr("data-scroll_fix")&&(a.attr("data-scroll_fix","true"),a.css("-webkit-overflow-scrolling","auto"),setTimeout(function(){a.css("-webkit-overflow-scrolling","touch")},500))}else{if(!f[t])return!1;f[t]=!1,a.css({height:"auto",display:"block"})}},clearInterval(e[c]),e[c]=setInterval(function(){f[c]=!1,smart_text_box?smart_text_box.scoll_tw_reinit(c):clearInterval(e[c])},500),i&&i(c),$(".text_window>div>div>div").eq(c).mousedown(function(t){t.stopPropagation()}),$(".text_window .close_text_window").eq(c).mousedown(function(){smart_text_box.close_text_window(c)}),$(" .text_window").eq(c).mousedown(function(){smart_text_box.close_text_window(c)}),o&&smart_text_box.reinit()},smart_text_box.show_iframe_window=function(t,e,a){smart_text_box.show_text_window('<div class="stb_iframe_cont"></div>',function(a){var i=$(".text_window").eq(a);i.find(".stb_iframe_cont").append($("<iframe>",{src:t,class:"stb_iframe",frameborder:0,scrolling:"no"}));i.find(".stb_iframe")[0].onload=function(){e&&(e(),e=null)}},a)},smart_text_box.close_text_window=function(a){return a||(a=0),a<$(".text_window").length-1&&smart_text_box.close_text_window(a+1),clearInterval(e[a]),!(t[a]&&!t[a]())&&(smart_text_box.global_callback_close&&smart_text_box.global_callback_close(),$(".text_window").eq(a).remove(),!1)},smart_text_box.reinit()});